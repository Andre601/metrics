name: Metrics embed
author: lowlighter
description: An infographics generator with 40+ plugins and 300+ options to display stats about your GitHub account!
branding:
  icon: user-check
  color: gray-dark

inputs:
  docker_image:
    description: Docker image to use
    default: ghcr.io/lowlighter/metrics:v4
    required: true
  config:
    description: Configuration file
    default: metrics.config.yml
    required: true

outputs:
  result:
    description: Result of the action

runs:
  using: composite
  steps:
    - uses: actions/checkout@v3
    - uses: denoland/setup-deno@v1
    - shell: bash
      env:
        INPUTS: ${{ toJson(inputs) }}
      run: |
        echo "::group::Metrics docker image setup"
        echo "GitHub action: $(echo '${{ github.action }}' | tr '_' '/')"
        cd ${{ github.action_path }}
        DOCKER_IMAGE="${{ inputs.docker_image }}"
        if [ -f "$DOCKER_IMAGE" ]; then
          echo "Using local docker image: $DOCKER_IMAGE"
          deno task btr docker:build
          DOCKER_IMAGE=metrics:dev
          # TODO(@lowlighter): pass the docker file as input
        else
          echo "Pulling remote docker image: $DOCKER_IMAGE"
          docker pull $DOCKER_IMAGE
        fi
        echo "::endgroup::"
        docker run --tty --env-file <(env | grep -E 'GITHUB|CI|TZ') --env INPUTS --rm --volume ${{ github.workspace }}:/workspace $DOCKER_IMAGE run
